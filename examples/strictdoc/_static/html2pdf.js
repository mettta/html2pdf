(()=>{"use strict";const e={root:"#printTHIS",footerTemplate:"#printTHISfooter",headerTemplate:"#printTHISheader",frontpageTemplate:"#printTHISfrontpage",frontpageContent:".frontpageContent",headerContent:".headerContent",footerContent:".footerContent",paperBody:".paperBody",paperHeader:".paperHeader",paperFooter:".paperFooter",virtualPaper:".virtualPaper",virtualPaperTopMargin:".virtualPaperTopMargin",virtualPaperBottomMargin:".virtualPaperBottomMargin",virtualPaperGap:".virtualPaperGap",paperFlow:"#paperFlow",contentFlow:"#contentFlow",runningSafety:".runningSafety",pageNumberRoot:"[data-page-number-root]",pageNumberCurrent:"[data-page-number-current]",pageNumberTotal:"[data-page-number-total]",printIgnore:"[data-print-ignore]",printHide:"[data-print-hide]",printNoBreak:"[data-print-no-break]",printPageBreak:"[data-print-page-break]",printForcedPageBreak:"[data-print-forced-page-break]",neutral:"[data-neutral]"};class t{constructor(e){this.DOM=e,this.body=e.body}insertStyle(e){const t=this.DOM.querySelector("head"),n=this.DOM.createElement("style");n.append(this.DOM.createTextNode(e)),n.setAttribute("data-printthis-inserted",""),t.append(n)}createDocumentFragment(){return this.DOM.createDocumentFragment()}getElement(e,t=this.DOM){return t.querySelector(e)}removeNode(e){e.remove()}cloneNode(e){return e?.cloneNode(!0)}cloneNodeWrapper(e){return e?.cloneNode(!1)}insertBefore(e,...t){e.before(...t)}insertAfter(e,...t){e.after(...t)}insertAtEnd(e,...t){e.append(...t)}insertAtStart(e,...t){e.prepend(...t)}insertInsteadOf(e,...t){e.before(...t),e.remove()}getRightNeighbor(e){return e.nextElementSibling}getLeftNeighbor(e){return e.previousElementSibling}getDataId(e){return e.dataset.id}setDataAttribute(e,t){e.setAttribute(t.substring(1,t.length-1),"")}setPrintNoBreak(t){this.setDataAttribute(t,e.printNoBreak)}wrapTextNode(e){if(!this.isSignificantTextNode(e))return;const t=this.createNeutral();return e.before(t),t.append(e),t}createNeutral(){const t=this.DOM.createElement("span");return this.setDataAttribute(t,e.neutral),t}createTestNode(){const e=this.createNeutral();return e.classList="test-node",e.style="position:absolute; left:-10000px; width:100%; background:rgba(255,255,255,0.2)",e}createTestNodeFrom(e){const t=e.cloneNode(!1);return t.classList="test-node",t.style.position="absolute",t.style.width="100%",t.style.background="rgb(255 239 177)",t}getLineHeight(e){const t=this.createNeutral();t.innerHTML="!",t.style="position:absolute; left:-10000px; width:100%;",e.append(t);const n=t.offsetHeight;return t.remove(),n}getEmptyNodeHeight(e){const t=e.cloneNode(!1);e.before(t);const n=t.offsetHeight;return t.remove(),n}isNeutral(e){return e.dataset?.hasOwnProperty("neutral")}isForcedPageBreak(e){return e.dataset?.hasOwnProperty("printForcedPageBreak")}isNoBreak(e){return e.dataset?.hasOwnProperty("printNoBreak")}getElementTagName(e){return e.tagName}isDocumentBody(e){return"BODY"===e.tagName}isTextNode(e){return e.nodeType===Node.TEXT_NODE}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}isSignificantTextNode(e){return!!this.isTextNode(e)&&e.nodeValue.trim().length>0}clearTemplates(e){e.querySelectorAll("template").forEach((e=>e.remove()))}getParentNode(e){return e.parentNode}getChildNodes(e){return e.childNodes}getChildren(e){return e.children}getInnerHTML(e){if("string"==typeof e){const t=this.DOM.querySelector(e);return t?t.innerHTML:void 0}return e.innerHTML}setInnerHTML(e,t){if("string"==typeof e){const n=this.DOM.querySelector(e);n&&(n.innerHTML=t)}e.innerHTML=t}setStyles(e,t){Object.entries(t).forEach((([t,n])=>e.style[t]=n))}create(e){if(!e)return this.DOM.createElement("div");const t=e.charAt(0);if("."===t){const t=e.substring(1),n=this.DOM.createElement("div");return n.classList.add(t),n}if("#"===t){const t=e.substring(1),n=this.DOM.createElement("div");return n.id=t,n}if("["===t){const t=e.substring(1,e.length-1),n=this.DOM.createElement("div");return n.setAttribute(t,""),n}return this.DOM.createElement(e)}createPrintPageBreak(){return this.create(e.printPageBreak)}createPrintNoBreak(t){const n=this.create(e.printNoBreak);return t&&(n.style=t),n}wrapWithPrintNoBreak(e){const t=this.createPrintNoBreak();return e.before(t),t.append(e),t}fitElementWithinBoundaries({element:e,height:t,width:n,vspace:r,hspace:i}){console.log(e);const s=r/t,o=i/n,a=s<o?s:o,h=Math.trunc(t*a),l=Math.trunc(n*a);e.style.height=h+"px",e.style.width=l+"px",e.setAttribute("height",`${h}px`),e.setAttribute("width",`${l}px`)}getElementBCR(e){return e.getBoundingClientRect()}getElementHeight(e){return e?.offsetHeight}getElementWidth(e){return e?.offsetWidth}getElementTop(e){return e?.offsetTop}getElementBottom(e){return e?.offsetTop+e?.offsetHeight||void 0}prepareSplittedNode(e){const t=e,n=e.innerHTML.split(" "),r=n.map((e=>{const t=this.DOM.createElement("span");return t.innerHTML=e+" ",t})),i=this.createTestNode();return i.append(...r),e.append(i),{splittedNode:t,nodeWords:n,nodeWordItems:r}}createSignpost(e,t=24){const n=this.create();return n.style.display="flex",n.style.flexWrap="nowrap",n.style.alignItems="center",n.style.justifyContent="center",n.style.textAlign="center",n.style.fontSize="8px",n.style.fontFamily="sans-serif",n.style.letterSpacing="1px",n.style.textTransform="uppercase",n.style.height=t+"px",e&&(n.innerHTML=e),n}createTable({wrapper:e,caption:t,thead:n,tfoot:r,tbody:i}){const s=e||this.create("table"),o=this.create("TBODY");return t&&s.append(t),n&&s.append(n),i&&o.append(...i),s.append(o),r&&s.append(r),s}}class n{constructor(e){this.config=e}create(){return`\n\n  @page {\n    size: A4;\n    /* 2 values: width then height */\n    size: ${this.config.width+this.config.printUnits} ${this.config.height+this.config.printUnits};\n\n    margin-left: ${this.config.left-1+this.config.printUnits};\n    margin-right: ${this.config.right-1+this.config.printUnits};\n    margin-top: ${this.config.top-0+this.config.printUnits};\n    margin-bottom: ${this.config.bottom-2+this.config.printUnits};\n  }\n\n  ${e.root} {\n    /* reset user styles */\n    display: block;\n\n    /* for proper printable flow positioning */\n    position: relative;\n\n    /* to compensate for possible BG in the parent node */\n    z-index: 1;\n\n    /* set print styles: affects previews */\n    margin: 0 auto;\n    width: ${this.config.width-this.config.left-this.config.right}${this.config.printUnits};\n    font-size: ${this.config.fontSize};\n\n    /* protection against unpredictability of margins */\n    padding-top: .1px;\n    padding-bottom: ${2*this.config.virtualPagesGap+this.config.screenUnits};\n  }\n\n  ${e.virtualPaper} {\n    display: grid;\n    grid-template-columns: 1fr;\n    grid-template-rows: minmax(min-content, max-content) minmax(min-content, max-content) 1fr minmax(min-content, max-content) minmax(min-content, max-content);\n    place-items: stretch stretch;\n    place-content: stretch stretch;\n    width: ${this.config.width-this.config.left-this.config.right}${this.config.printUnits};\n    height: ${this.config.height}${this.config.printUnits};\n    font-size: ${this.config.fontSize};\n  }\n\n  ${e.virtualPaper}::before {\n    position: absolute;\n    content: '';\n    width: ${this.config.width}${this.config.printUnits};\n    height: ${this.config.height}${this.config.printUnits};\n    left: -${this.config.left}${this.config.printUnits};\n    background-color: #fff;\n    box-shadow: rgba(0, 0, 0, 0.1) 2px 2px 12px 0px;\n    z-index: -1;\n  }\n\n  ${e.headerContent} {\n    padding-bottom: ${this.config.headerMargin}${this.config.screenUnits};\n  }\n\n  ${e.footerContent} {\n    padding-top: ${this.config.footerMargin}${this.config.screenUnits};\n  }\n\n  ${e.paperFlow} {\n    position: absolute;\n    width: 100%;\n    z-index: -1;\n    /* affect only screen */\n    padding-bottom: 100px;\n  }\n\n  ${e.runningSafety} {\n    padding: .1px;\n  }\n\n  ${e.virtualPaperTopMargin} {\n    height: ${this.config.top}${this.config.printUnits};\n  }\n\n  ${e.virtualPaperBottomMargin} {\n    height: ${this.config.bottom}${this.config.printUnits};\n  }\n\n  ${e.virtualPaperGap} {\n    padding-top: ${this.config.virtualPagesGap}${this.config.screenUnits};\n  }\n\n  ${e.frontpageContent} {\n    transform-origin: top center;\n    padding: .1px;\n  }\n\n  ${e.neutral},\n  ${e.neutral} span {\n    padding: 0;\n    margin: 0;\n    font: inherit;\n    color: inherit;\n    line-height: inherit;\n    background: none;\n    background-color: transparent;\n  }\n\n  @media print {\n    ${e.paperFlow} {\n      padding-bottom: 0;\n    }\n\n    ${e.printIgnore},\n    ${e.virtualPaper} {\n      display: contents;\n    }\n\n    ${e.virtualPaper}::before,\n    ${e.printHide},\n    ${e.virtualPaperTopMargin},\n    ${e.virtualPaperBottomMargin},\n    ${e.virtualPaperGap} {\n      display: none;\n    }\n\n    ${e.printPageBreak} {\n      break-after: page;\n      padding: .1px;\n    }\n\n    ${e.printForcedPageBreak} {\n      /* JUST MANUAL! */\n      /* break-after: page; */\n    }\n\n    ${e.printNoBreak} {\n      break-inside: avoid-page;\n    }\n  }\n\n  /* FOR TEST*/\n  ${e.virtualPaperGap} {\n    background: #ff000020;\n  }\n\n  ${e.paperFooter},\n  ${e.paperHeader} {\n    background: #fa96ff20;\n  }\n  ${e.paperBody} {\n    background: #ffee0020;\n  }\n  ${e.runningSafety} {\n    background: #f200ff;\n  }\n  ${e.frontpageContent} {\n    background: #00fcff20;\n  }\n\n  ${e.neutral} {\n    background: #00ffee10;\n  }\n\n`}}class r{constructor({DOM:e,selector:t}){this.DOM=e,this.selector=t,this.rootSelector=t?.root,this.paperFlowSelector=t?.paperFlow,this.contentFlowSelector=t?.contentFlow,this.printIgnoreElementSelector=t?.printIgnore,this.printHideElementSelector=t?.printHide,this.root=this._initRoot(),this.paperFlow=this._createPaperFlow(),this.contentFlow=this._createContentFlow()}create(){this.DOM.setInnerHTML(this.root,""),this.DOM.insertAtEnd(this.root,this.paperFlow,this.contentFlow),this._ignorePrintingEnvironment(this.root)}_initRoot(){const e=this.DOM.getElement(this.rootSelector)||this.DOM.body;return e||console.warn(`Add ${this.rootSelector} to the root element of the area you want to print`),e}_createPaperFlow(){return this.DOM.create(this.paperFlowSelector)}_createContentFlow(){const e=this.DOM.create(this.contentFlowSelector);return this.DOM.setInnerHTML(e,this.DOM.getInnerHTML(this.root)),this.DOM.clearTemplates(e),this.DOM.insertAtEnd(e,this.DOM.create("[data-content-flow-end]")),e}_ignorePrintingEnvironment(e){let t=this.DOM.getParentNode(e);this.DOM.setDataAttribute(t,this.printIgnoreElementSelector),this.DOM.getChildNodes(t).forEach((t=>{if(t!==e&&this.DOM.isElementNode(t))this.DOM.setDataAttribute(t,this.printHideElementSelector);else{if(!this.DOM.isSignificantTextNode(t))return;this.DOM.setDataAttribute(this.DOM.wrapTextNode(t),this.printHideElementSelector)}})),this.DOM.isDocumentBody(t)||this._ignorePrintingEnvironment(t)}}class i{constructor({DOM:e,contentFlow:t,referenceWidth:n,referenceHeight:r}){this.DOM=e,this.contentFlow=t,this.referenceWidth=n,this.referenceHeight=r,this.minLeftLines=2,this.minDanglingLines=2,this.minBreakableLines=this.minLeftLines+this.minDanglingLines,this.minLeftRows=2,this.minDanglingRows=2,this.minBreakableRows=this.minLeftRows+this.minDanglingRows,this.minPreFirstBlockLines=3,this.minPreLastBlockLines=3,this.minPreBreakableLines=this.minPreFirstBlockLines+this.minPreLastBlockLines,this.imageReductionRatio=.8,this.signpostHeight=24,this.pages=[]}calculate(){return this._calculate(),this.pages}_calculate(){if(this.DOM.getElementHeight(this.contentFlow)<this.referenceHeight)return void this._registerPageStart(this.contentFlow);const e=this._getChildren(this.contentFlow);this._registerPageStart(e[0]),this._parseNodes({array:e})}_registerPageStart(e){this.pages.push({pageStart:e})}_parseNodes({array:e,previous:t,next:n}){for(let r=0;r<e.length;r++)this._parseNode({previousElement:e[r-1]||t,currentElement:e[r],nextElement:e[r+1]||n})}_parseNode({previousElement:e,currentElement:t,nextElement:n}){if(!n)return;const r=this.pages[this.pages.length-1].pageStart,i=(r?this.DOM.getElementTop(r):0)+this.referenceHeight;if(this.DOM.isForcedPageBreak(t))this._registerPageStart(n);else if(this.DOM.getElementTop(n)>i){if(this._canNotBeLast(t))return void this._registerPageStart(t);if(this._isSVG(t)||this._isIMG(t)){const e=this._isSVG(t)?this.DOM.wrapWithPrintNoBreak(t):t,r=i-this.DOM.getElementTop(e),s=this.DOM.getElementHeight(e),o=this.DOM.getElementWidth(e);return s<this.referenceWidth&&console.warn("%c IMAGE is too wide","color: red"),s<r?void this._registerPageStart(n):r/s>this.imageReductionRatio?(this._registerPageStart(n),void this.DOM.fitElementWithinBoundaries({element:t,height:s,width:o,vspace:r,hspace:this.referenceWidth})):(this._registerPageStart(e),void(s>this.referenceHeight&&this.DOM.fitElementWithinBoundaries({element:t,height:s,width:o,vspace:this.referenceHeight,hspace:this.referenceWidth})))}if(this.DOM.getElementBottom(t)<=i)return console.log("%c -- check BOTTOM of","color:yellow",t),void this._registerPageStart(n);let r=[];r=this.DOM.isNoBreak(t)||this._notSolved(t)?[]:this._isTextNode(t)?this._splitTextNode(t,i)||[]:this._isPRE(t)?this._splitPreNode(t,i)||[]:this._isTableNode(t)?this._splitTableNode(t,i)||[]:this._getChildren(t),r.length?this._parseNodes({array:r,previous:e,next:n}):this._canNotBeLast(e)?this._registerPageStart(e):this._registerPageStart(t)}}_canNotBeLast(e){const t=this.DOM.getElementTagName(e);return"H1"===t||"H2"===t||"H3"===t||"H4"===t||"H5"===t||"H6"===t}_isPRE(e){return"PRE"===this.DOM.getElementTagName(e)}_isIMG(e){return"IMG"===this.DOM.getElementTagName(e)}_isSVG(e){return"svg"===this.DOM.getElementTagName(e)}_splitPreNode(e,t){console.log("PRE",e);const n=this.DOM.getElementTop(e),r=this.DOM.getElementHeight(e),i=this.DOM.getLineHeight(e),s=this.DOM.getEmptyNodeHeight(e),o=(r-s)/i;if(o<this.minPreBreakableLines)return void this._registerPageStart(e);let a=t-n-s;const h=this.referenceHeight-s;let l=Math.trunc(a/i);const p=Math.trunc(h/i);l<this.minPreFirstBlockLines&&(console.log("availableSpace is too small"),a=this.referenceHeight,l=p);const c=o-l,g=(Math.floor(c/p),c%p);g<this.minPreLastBlockLines&&(l-=this.minPreLastBlockLines-g);let d=this.DOM.getInnerHTML(e);"\n"===d.charAt(d.length-1)&&(d=d.slice(0,-1)),console.log("1 - preText");const u=d.split("\n");console.log("2 - preLines",u);const m=u.reduce(((e,t,n,r)=>(""===t?e.push([]):e[e.length-1].push(t),e)),[[]]).filter((e=>e.length));let f="",M="";m[0].length<this.minPreFirstBlockLines&&(f=m.shift().join("\n")+"\n\n"),m[m.length-1].length<this.minPreLastBlockLines&&(M="\n"+m.pop().join("\n")),console.log("3 - preGroupedLines",m);const D=m.reduce(((e,t,n,r)=>{if(t.length<this.minPreBreakableLines)e.push(t.join("\n")+"\n");else{const n=t.slice(0,this.minPreFirstBlockLines).join("\n")+"\n",r=t.slice(this.minPreFirstBlockLines,-this.minPreLastBlockLines).map((e=>e+"\n")),i=t.slice(-this.minPreLastBlockLines).join("\n")+"\n";e.push(n),r.length&&e.push(...r),e.push(i)}return e.push("\n"),e}),[]);"\n"===D[D.length-1]&&D.pop(),f.length&&(D[0]=f+D[0]),M.length&&(D[D.length-1]=D[D.length-1]+M),console.log("4 - preBlocks",D);const O=D.map((e=>{const t=this.DOM.createNeutral();return this.DOM.setInnerHTML(t,e),t})),P=this.DOM.createTestNodeFrom(e);P.append(...O),e.append(P);let T=0,S=[],b=a;for(let e=0;e<O.length;e++){const t=O[e];this.DOM.getElementBottom(t)>b&&(S.push(e),T+=1,b=this.DOM.getElementTop(t)+h)}S.push(null),console.log(S);const N=S.map(((t,n,r)=>{const i=this.DOM.cloneNodeWrapper(e);this.DOM.setPrintNoBreak(i);const s=r[n-1]||0,o=t||r[r.length];return i.append(...O.slice(s,o)),i}));return console.log("PRE splitsArr",N),this.DOM.insertInsteadOf(e,...N),N}_splitTableNode(e,t){console.log("%c WE HAVE A TABLE","color:yellow"),console.log("pageBottom",t),console.log("nodeBottom",this.DOM.getElementBottom(e)),console.time("_splitTableNode");const n=this.DOM.getEmptyNodeHeight(e),r=[...e.children].reduce((function(e,t){const n=t.tagName;return"TBODY"===n?{...e,rows:[...e.rows,...t.children]}:"CAPTION"===n?{...e,caption:t}:"THEAD"===n?{...e,thead:t}:"TFOOT"===n?{...e,tfoot:t}:"TR"===n?{...e,rows:[...e.rows,...t]}:{...e,unexpected:[...e.unexpected,...t]}}),{caption:null,thead:null,tfoot:null,rows:[],unexpected:[]});if(console.log("nodeEntries",r),r.unexpected.length>0&&console.warn("something unexpected is found in the table"),r.rows.length<this.minBreakableRows)return[];const i=this.DOM.getElementTop(e),s=this.DOM.getElementHeight(e),o=t-i-this.signpostHeight-n,a=this.referenceHeight-this.DOM.getElementHeight(r.thead)-this.DOM.getElementHeight(r.tfoot)-this.DOM.getElementHeight(r.caption)-2*this.signpostHeight-n,h=[...r.rows.map((e=>this.DOM.getElementTop(e))),this.DOM.getElementTop(r.tfoot)||s];let l=[],p=o;for(let e=0;e<h.length;e++)h[e]>p&&(e>this.minLeftRows&&l.push(e-1),p=h[e-1]+a);const c=h.length-1-this.minDanglingRows;l[l.length-1]>c&&(l[l.length-1]=c),console.log("splitsIds",l);const g=(t,n)=>{const i=this.DOM.cloneNodeWrapper(e),s=r.rows.slice(t,n),o=this.DOM.createPrintNoBreak();return e.before(o),t&&o.append(this.DOM.createSignpost("(table continued)",this.signpostHeight)),o.append(this.DOM.createTable({wrapper:i,caption:this.DOM.cloneNode(r.caption),thead:this.DOM.cloneNode(r.thead),tbody:s}),this.DOM.createSignpost("(table continues on the next page)",this.signpostHeight)),o},d=l.map(((e,t,n)=>g(n[t-1]||0,e)));console.log("splits",d);const u=this.DOM.createPrintNoBreak();return e.before(u),u.append(this.DOM.createSignpost("(table continued)",this.signpostHeight),e),console.timeEnd("_splitTableNode"),[...d,u]}_splitTextNode(e,t){const n=this.DOM.getElementTop(e),r=this.DOM.getElementHeight(e),i=this.DOM.getLineHeight(e),s=t-n,o=function({pageLines:e,nodeLines:t,firstPartLines:n,minBreakableLines:r,minLeftLines:i,minDanglingLines:s}){let o=[];if(t<r)return[];n<i&&(n=e),function r(i=0){const s=e*i+n,a=i?s-e*(i-1):n;if(t>s)return o=[...o,{endLine:s,splitter:s/t,partLines:a}],void r(i+1);const h=t-(s-e);o=[...o,{endLine:null,splitter:null,partLines:h}]}();const a=o.length-2,h=o.length-1;if(o[h].partLines<s){const e=s-o[h].partLines,n=o[a].endLine-e,r=n/t;o[a]={endLine:n,splitter:r,partLines:o[a].partLines-e},o[h].partLines=o[h].partLines+e}return o}({nodeLines:~~(r/i),pageLines:~~(this.referenceHeight/i),firstPartLines:~~(s/i),minBreakableLines:this.minBreakableLines,minLeftLines:this.minLeftLines,minDanglingLines:this.minDanglingLines});if(o.length<2)return console.log(" ... do not break",e),[];const{splittedNode:a,nodeWords:h,nodeWordItems:l}=this.DOM.prepareSplittedNode(e),p=o.map((({endLine:e,splitter:t})=>t?function({arr:e,floater:t,topRef:n,getElementTop:r}){const i=(t,s)=>{const o=t+1,a=e[o],h=r(a);return s<h&&h===n?o:i(o,h)},s=(t,i)=>{const o=t-1,a=e[o],h=r(a);return h<i&&i===n?t:s(o,h)},o=~~(e.length*t),a=r(e[o]);return a<n?i(o,a):s(o,a)}({arr:l,floater:t,topRef:e*i,getElementTop:this.DOM.getElementTop}):null)).map(((e,t,n)=>{const r=this.DOM.createPrintNoBreak(),i=n[t-1]||0,s=e||n[n.length];return this.DOM.setInnerHTML(r,h.slice(i,s).join(" ")+" "),r}));return this.DOM.insertInsteadOf(a,...p),p}_getChildren(e){return[...this.DOM.getChildNodes(e)].map((e=>this.DOM.isSignificantTextNode(e)?this.DOM.wrapTextNode(e):e)).filter((e=>this.DOM.isElementNode(e)))}_isSignificantChild(e){const t=this.DOM.getElementTagName(e);return"A"!==t&&"TT"!==t&&this.DOM.getElementHeight(e)>0}_isTextNode(e){return this.DOM.isNeutral(e)}_isTableNode(e){return"TABLE"===this.DOM.getElementTagName(e)}_notSolved(e){return"OBJECT"===this.DOM.getElementTagName(e)}}class s{constructor({DOM:e,selector:t}){this.DOM=e,this.selector=t,this.frontpageTemplateSelector=t?.frontpageTemplate,this.headerTemplateSelector=t?.headerTemplate,this.footerTemplateSelector=t?.footerTemplate,this.paperBodySelector=t?.paperBody||".paperBody",this.paperHeaderSelector=t?.paperHeader||".paperHeader",this.paperFooterSelector=t?.paperFooter||".paperFooter",this.headerContentSelector=t?.headerContent||".headerContent",this.footerContentSelector=t?.footerContent||".footerContent",this.frontpageContentSelector=t?.frontpageContent||".frontpageContent",this.virtualPaperSelector=t?.virtualPaper||".virtualPaper",this.virtualPaperTopMarginSelector=t?.virtualPaperTopMargin||".virtualPaperTopMargin",this.virtualPaperBottomMarginSelector=t?.virtualPaperBottomMargin||".virtualPaperBottomMargin",this.pageNumberRootSelector=t?.pageNumberRoot||void 0,this.pageNumberCurrentSelector=t?.pageNumberCurrent||void 0,this.pageNumberTotalSelector=t?.pageNumberTotal||void 0,this.frontpageTemplate=this.DOM.getInnerHTML(this.frontpageTemplateSelector),this.headerTemplate=this.DOM.getInnerHTML(this.headerTemplateSelector),this.footerTemplate=this.DOM.getInnerHTML(this.footerTemplateSelector),this.paperHeight,this.headerHeight,this.footerHeight,this.bodyHeight,this.bodyWidth,this.frontpageFactor,this._calculatePaperParams()}create({currentPage:e,totalPages:t}){const n=this._createPaperBody(this.bodyHeight),r=this._createPaperHeader(this.headerTemplate),i=this._createPaperFooter(this.footerTemplate);return this._createPaper({header:r,body:n,footer:i,currentPage:e,totalPages:t})}createFrontpage({currentPage:e,totalPages:t}){const n=this._createFrontpageContent(this.frontpageTemplate,this.frontpageFactor),r=this._createPaperBody(this.bodyHeight,n),i=this._createPaperHeader(this.headerTemplate),s=this._createPaperFooter(this.footerTemplate);return this._createPaper({header:i,body:r,footer:s,currentPage:e,totalPages:t})}createVirtualTopMargin(){return this.DOM.create(this.virtualPaperTopMarginSelector)}createVirtualBottomMargin(){return this.DOM.create(this.virtualPaperBottomMarginSelector)}_createPaper({header:e,body:t,footer:n,currentPage:r,totalPages:i}){const s=this.DOM.create(this.virtualPaperSelector);return this.DOM.insertAtEnd(s,this.createVirtualTopMargin(),e,t,n,this.createVirtualBottomMargin()),r&&i&&(this._setPageNumber(e,r,i),this._setPageNumber(n,r,i)),s}_createFrontpageContent(e,t){const n=this.DOM.create(this.frontpageContentSelector);return e&&this.DOM.setInnerHTML(n,e),t&&this.DOM.setStyles(n,{transform:`scale(${t})`}),n}_createPaperBody(e,t){const n=this.DOM.create(this.paperBodySelector);return this.DOM.setStyles(n,{height:e+"px"}),t&&this.DOM.insertAtEnd(n,t),n}_createPaperHeader(e){const t=this.DOM.create(this.paperHeaderSelector);if(e){const n=this.DOM.create(this.headerContentSelector);this.DOM.setInnerHTML(n,e),this.DOM.insertAtEnd(t,n)}return t}_createPaperFooter(e){const t=this.DOM.create(this.paperFooterSelector);if(e){const n=this.DOM.create(this.footerContentSelector);this.DOM.setInnerHTML(n,e),this.DOM.insertAtEnd(t,n)}return t}_setPageNumber(e,t,n){const r=this.pageNumberRootSelector?this.DOM.getElement(this.pageNumberRootSelector,e):this.pageNumberRootSelector;if(r){const e=this.DOM.getElement(this.pageNumberCurrentSelector,r),i=this.DOM.getElement(this.pageNumberTotalSelector,r);this.DOM.setInnerHTML(e,t),this.DOM.setInnerHTML(i,n)}}_calculatePaperParams(){const e=this._createPaperBody(),t=this._createFrontpageContent(this.frontpageTemplate),n=this._createPaperHeader(this.headerTemplate),r=this._createPaperFooter(this.footerTemplate),i=this._createPaper({header:n,body:e,footer:r}),s=this.DOM.create("#workbench");this.DOM.setStyles(s,{position:"absolute",left:"-3000px"}),this.DOM.insertAtEnd(s,i),this.DOM.insertAtStart(this.DOM.body,s);const o=this.DOM.getElementBCR(i).height,a=this.DOM.getElementHeight(n)||0,h=this.DOM.getElementHeight(r)||0,l=this.DOM.getElementHeight(e),p=this.DOM.getElementWidth(e);this.DOM.insertAtStart(e,t);const c=this.DOM.getElementHeight(e),g=c>l?l/c:1;this.DOM.removeNode(s),a>.2*o&&console.warn("It seems that your custom header is too high"),h>.15*o&&console.warn("It seems that your custom footer is too high"),g<1&&console.warn("It seems that your frontpage content is too large. We made it smaller to fit on the page. Check out how it looks! It might make sense to fix this with styles or reduce the text amount."),this.paperHeight=o,this.headerHeight=a,this.footerHeight=h,this.bodyHeight=l,this.bodyWidth=p,this.frontpageFactor=g}}class o{constructor({DOM:e,selector:t,pages:n,contentFlow:r,paperFlow:i,paper:s}){this.DOM=e,this.selector=t,this.virtualPaperGapSelector=t?.virtualPaperGap,this.runningSafetySelector=t?.runningSafety,this.printPageBreakSelector=t?.printPageBreak,this.pages=n,this.contentFlow=r,this.paperFlow=i,this.paper=s}create(){this._processFirstPage(),this._processOtherPages()}_processFirstPage(){let e;if(this.paper.frontpageTemplate){const t=this._insertFrontpageSpacer(this.contentFlow,this.paper.bodyHeight);this.pages.unshift({pageStart:t}),e=this.paper.createFrontpage({currentPage:1,totalPages:this.pages.length})}else e=this.paper.create({currentPage:1,totalPages:this.pages.length});this._insertIntoPaperFlow(e),this._insertIntoContentFlow(this.pages[0].pageStart)}_processOtherPages(){for(let e=1;e<this.pages.length;e++){const t=this.paper.create({currentPage:e+1,totalPages:this.pages.length}),n=this._createVirtualPaperGap();this._insertIntoPaperFlow(t,n),this._insertIntoContentFlow(this.pages[e].pageStart,n)}}_insertIntoPaperFlow(e,t){this._insertPaper(this.paperFlow,e,t)}_insertIntoContentFlow(e,t){t&&this._insertFooterSpacer(e,this.paper.footerHeight,t),this._insertHeaderSpacer(e,this.paper.headerHeight)}_insertPaper(e,t,n){n?this.DOM.insertAtEnd(e,n,t):this.DOM.insertAtEnd(e,t)}_createVirtualPaperGap(){return this.DOM.create(this.virtualPaperGapSelector)}_createVirtualPaperTopMargin(){return this.paper.createVirtualTopMargin()}_createVirtualPaperBottomMargin(){return this.paper.createVirtualBottomMargin()}_insertFrontpageSpacer(e,t){const n=this.DOM.create();return this.DOM.setStyles(n,{paddingBottom:t+"px"}),this.DOM.insertAtStart(e,n),n}_insertHeaderSpacer(e,t){const n=this.DOM.create(this.runningSafetySelector);t&&this.DOM.setStyles(n,{marginBottom:t+"px"});const r=this.DOM.createDocumentFragment();this.DOM.insertAtEnd(r,this._createVirtualPaperTopMargin(),n),this.DOM.insertBefore(e,r)}_insertFooterSpacer(e,t,n){const r=this.DOM.create(this.runningSafetySelector);t&&this.DOM.setStyles(r,{marginTop:t+"px"});const i=this._createVirtualPaperGap(),s=this.DOM.createDocumentFragment();this.DOM.insertAtEnd(s,r,this._createVirtualPaperBottomMargin(),this.DOM.create(this.printPageBreakSelector),i),this.DOM.insertBefore(e,s);const o=this.DOM.getElementTop(n)-this.DOM.getElementTop(i);this.DOM.setStyles(r,{marginBottom:o+"px"})}}window.addEventListener("load",(function(a){console.time("printTHIS");const h=new t(window.document);h.insertStyle(new n({printUnits:"mm",width:"210",height:"297",left:"21",right:"21",top:"10",bottom:"12",fontSize:"11pt",screenUnits:"px",headerMargin:"16",footerMargin:"16",virtualPagesGap:"16"}).create());const l=new s({DOM:h,selector:e}),p=new r({DOM:h,selector:e});p.create();const c=new i({DOM:h,contentFlow:p.contentFlow,referenceHeight:l.bodyHeight,referenceWidth:l.bodyWidth}).calculate();console.log(c),new o({DOM:h,selector:e,contentFlow:p.contentFlow,paperFlow:p.paperFlow,paper:l,pages:c}).create(),console.timeEnd("printTHIS")}))})();